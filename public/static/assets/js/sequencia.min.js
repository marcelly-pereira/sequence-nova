document.addEventListener("DOMContentLoaded",function(){var e=window.location.pathname.split("/");const m=e[e.length-2],a=document.getElementById("phase-row"),u=document.getElementById("error-message"),h=new WebSocket(`ws://${window.location.host}/ws/sequencia/${m}/`),t=document.getElementById("searchInput");e=document.querySelector(".search-button").closest("form");let f="";fetch(`/api/sequenciasdetail/${m}/`).then(a=>a.ok?a.json():a.text().then(e=>{throw new Error(`Erro na resposta da API: ${a.statusText} - `+e)})).then(e=>{f=e.cor,console.log("Cor da sequência:",f)}).catch(e=>{console.error("Erro ao buscar a cor da sequência:",e)}),e.addEventListener("submit",function(e){e.preventDefault();const p=t.value.toLowerCase(),a=(console.log("Procurando texto digitado:",p),[]);document.querySelectorAll(".sequence-card-body h4").forEach(e=>{e.textContent.toLowerCase().includes(p)&&a.push(e.textContent)}),console.log("Cards correspondentes:",a),document.querySelectorAll(".sequence-card-body").forEach(e=>{e.closest(".card").style.display=a.includes(e.querySelector("h4").textContent)?"block":"none"}),fetch(`/api/sequencia/${m}/fases/`).then(e=>e.json()).then(c=>{if(n(),c.length){let n=c.length,o=0,i=!1;c.forEach(a=>{var r,s,d,t,l;r=a.id,s=p,d=1,t=5,l=null,new Promise((n,a)=>{d<1&&(console.warn(`Página inválida (${d}), ajustando para 1.`),d=1);const o=document.getElementById("spinner-container-"+r);o.style.display="flex";let e=`/api/sequencia/${m}/cards/?fase=${r}&page=${d}&page_size=${t}&search=`+encodeURIComponent(s);l&&(e+="&responsavel="+l),fetch(e).then(a=>a.ok?a.json():a.json().then(e=>{throw new Error(`Erro ${a.status}: `+(e.error||e.message))})).then(e=>{if(o.style.display="none",e.results&&0!==e.results.length){const t=document.querySelector(`.phase-cards[data-fase-id='${r}']`);var a;t&&(e.results.forEach(e=>{var a;e.fase==r&&(document.querySelector(`.phase-cards[data-fase-id='${r}'] [data-card-id='${e.id}']`)?console.warn(`⚠️ Card ${e.id} já foi carregado na fase ${r}, ignorando.`):((a=document.createElement("div")).className="card mb-0",a.setAttribute("draggable","true"),a.setAttribute("data-card-id",e.id),a.innerHTML=v(e),t.insertBefore(a,t.querySelector(".ghost-card")),a.querySelector(".sequence-card-body").addEventListener("click",function(){S(e)})))}),(a=Array.from(t.children).filter(e=>e.classList.contains("card"))).sort((e,a)=>{var t=e=>{e=e.querySelector("#etiquetas-vencimento").textContent;return e.includes("Vencido")?-1:e.includes("minutos")?parseInt(e.replace(/\D/g,"")):e.includes("horas")?60*parseInt(e.replace(/\D/g,"")):e.includes("dias")?1440*parseInt(e.replace(/\D/g,"")):1/0};return t(e)-t(a)}),a.forEach(e=>t.appendChild(e)),A(t),n(e.results))}else console.warn(`📌 Nenhum card encontrado com o título contendo "${s}" na página ${d} da fase ${r}.`),A(document.querySelector(`.phase-cards[data-fase-id='${r}']`)),n([])}).catch(e=>{console.warn(`❌SearchCardsByTitle: Erro ao carregar mais cards na fase ${r}:`,e),o.style.display="none",a(e)})}).then(e=>{o++,0<e.length&&(i=!0,u.style.display="none",console.log(`Cards encontrados na fase ${a.id}:`,e),T()),o!==n||i||(u.textContent='Nenhum card encontrado com o título contendo "'+p+'" nas fases: '+c.map(e=>e.nome).join(", ")+".",u.style.display="block")}).catch(e=>{o++,console.error("Erro ao buscar cards por título:",e),o!==n||i||(u.textContent="Erro ao buscar cards.",u.style.display="block")})})}}).catch(e=>{console.error("Erro ao buscar fases:",e),u.textContent="Erro ao buscar fases.",u.style.display="block"})});const d={};function l(e){var a,t=document.querySelector(`.phase-card-col[data-fase-id="${e}"]`);t?(t=t.querySelector(".task-header span:last-child"),a=d[e]||0,t.textContent=a+" Cards",console.log(`Fase ID: ${e}, Nova quantidade: `+a)):console.warn(`⚠️ Elemento da fase ${e} não encontrado no DOM.`)}function i(e){var a=document.querySelector(`[data-card-id="${e}"]`);a?a.remove():console.warn(`⚠️ Card ${e} já foi removido ou não existe no DOM.`)}function n(){bootstrap.Modal.getInstance(document.getElementById("spinnerModal")).hide()}function v(t){var e=t.responsavel_nome&&0<t.responsavel_nome.length?t.responsavel_nome.map((e,a)=>{a=t.responsavel_foto_perfil[a];return a?`<img id="responsavel-${t.id}" src="${a}" alt="${e}" title="${e}" 
                            style="width: 24px; height: 24px; border-radius: 50%; margin-right: 1px;">`:e}).join(" "):'<i class="mdi mdi-account-outline" style="color: red;"></i> N/R',a=t.vencimento?t.tempo_para_vencimento.includes("Vencido")?`<span class="badge bg-danger text-white">${t.tempo_para_vencimento}</span>`:t.tempo_para_vencimento.includes("minutos")||t.tempo_para_vencimento.includes("horas")?`<span class="badge bg-warning text-dark">${t.tempo_para_vencimento}</span>`:`<span class="badge bg-dark text-white">${t.tempo_para_vencimento}</span>`:"";return`
            <div class="sequence-card-body">
                <h4 id="card-title-${t.id}">${t.titulo}</h4>

                <!-- Exibição dinâmica dos campos -->
                ${t.field_values.filter(e=>e.exibirnocard&&e.value).map(e=>{return`
                    <div class="field">
                        <div class="icon-box">
                            ${a=e.field_type,t={short_text:"fas fa-font",long_text:"fas fa-align-left",number:"fas fa-hashtag",select:"fas fa-list",cnpj:"fas fa-id-card",cpf:"fas fa-id-card",currency:"fas fa-dollar-sign",attachment:"fas fa-paperclip",assignee_select:"fas fa-user",date:"fas fa-calendar-alt",datetime:"fas fa-clock",time:"fas fa-clock",due_date:"fas fa-calendar-check",label_select:"fas fa-tags",phone:"fas fa-phone",checklist_vertical:"fas fa-tasks",statement:"fas fa-file-alt",radio_horizontal:"fas fa-dot-circle",radio_vertical:"fas fa-dot-circle",checkbox_horizontal:"fas fa-check-square",checkbox_vertical:"fas fa-check-square",email:"fas fa-envelope",url:"fas fa-link",address:"fas fa-map-marker-alt"},t[a]?`<i class="${t[a]}"></i>`:""}
                        </div>
                        <span class="text-muted">
                            <strong>${e.form_field_label}</strong>: ${e.value}
                        </span><br>
                    </div>
                `;var a,t}).join("")}

                <!-- Responsável e vencimento -->
                <div id="card-responsavel-${t.id}" class="card-responsavel" style="padding: 10px auto;">
                    <span class="text-muted d-flex align-items-center mt-1" style="font-size: 14px; gap: 5px;"> 
                        <span id="responsavel-container-card${t.id}">
                            ${e}
                        </span>
                        <i class="mdi mdi-clock-outline" style="font-size: 16px;"></i>
                        <span>${t.tempo_criacao}</span>
                        <i class="mdi mdi-calendar-outline" style="font-size: 16px;"></i>
                        <span id="etiquetas-vencimento-${t.id}">${a}</span>
                    </span>
                </div>
            </div>`}function c(r,s=1,t=5,d=null){return new Promise((n,a)=>{s<1&&(console.warn(`Página inválida (${s}), ajustando para 1.`),s=1);const o=document.getElementById("spinner-container-"+r);o.style.display="flex";let e=`/api/sequencia/${m}/cards/?fase=${r}&page=${s}&page_size=`+t;d&&(e+="&responsavel="+d),fetch(e).then(a=>a.ok?a.json():a.json().then(e=>{throw new Error(`Erro ${a.status}: `+(e.error||e.message))})).then(e=>{if(o.style.display="none",e.results&&0!==e.results.length){const t=document.querySelector(`.phase-cards[data-fase-id='${r}']`);var a;t&&(e.results.forEach(e=>{var a;e.fase==r&&(document.querySelector(`.phase-cards[data-fase-id='${r}'] [data-card-id='${e.id}']`)?console.warn(`⚠️ Card ${e.id} já foi carregado na fase ${r}, ignorando.`):((a=document.createElement("div")).className="card mb-0",a.setAttribute("draggable","true"),a.setAttribute("data-card-id",e.id),a.innerHTML=v(e),t.insertBefore(a,t.querySelector(".ghost-card")),a.querySelector(".sequence-card-body").addEventListener("click",function(){S(e)})))}),(a=Array.from(t.children).filter(e=>e.classList.contains("card"))).sort((e,a)=>{var t=e=>{e=e.querySelector("#etiquetas-vencimento").textContent;return e.includes("Vencido")?-1:e.includes("minutos")?parseInt(e.replace(/\D/g,"")):e.includes("horas")?60*parseInt(e.replace(/\D/g,"")):e.includes("dias")?1440*parseInt(e.replace(/\D/g,"")):1/0};return t(e)-t(a)}),a.forEach(e=>t.appendChild(e)),A(t),n(e.results))}else console.warn(`📌 Nenhum card encontrado na página ${s} da fase ${r}.`),A(document.querySelector(`.phase-cards[data-fase-id='${r}']`)),n([])}).catch(e=>{console.warn(`❌LoadCards:  Erro ao carregar mais cards na fase ${r}:`,e),o.style.display="none",a(e)})})}function p(e){var a=document.createElement("div"),t=(a.classList.add("form-group"),x(e)),n=E(e),o=function(a){const t=a.value;{var e;if(console.log(t),!t)return(e=document.createElement("div")).classList.add("alert","alert-info"),e.textContent="Clique aqui para adicionar",e}const n=document.createElement("div"),o=(n.classList.add("card","mb-3","border","shadow-sm","p-2","empresa-card"),document.createElement("div")),r=(o.classList.add("card-body","d-flex","align-items-center"),o.style.padding="3px",document.createElement("div")),s=(r.classList.add("empresa-avatar"),r.textContent="MD",document.createElement("div")),d=(s.classList.add("ms-3","w-100"),document.createElement("div")),l=(d.classList.add("form-check"),document.createElement("label")),i=(l.htmlFor="empresa_"+t,l.classList.add("form-check-label"),l.innerHTML="<strong>...</strong>",d.appendChild(l),document.createElement("hr")),c=(i.classList.add("my-2"),document.createElement("p")),p=(c.classList.add("card-text","text-muted"),c.innerHTML="<strong>Razão Social:</strong> ....",document.createElement("p")),m=(p.classList.add("card-text","text-muted"),p.innerHTML="<strong>Regime Tributário:</strong> ...",document.createElement("p")),u=(m.classList.add("card-text","text-muted"),m.innerHTML="<strong>CNPJ:</strong> ...",document.createElement("p")),h=(u.classList.add("card-text","text-muted"),u.innerHTML="<strong>Cidade:</strong> ...",s.appendChild(d),s.appendChild(i),s.appendChild(c),s.appendChild(p),s.appendChild(u),o.appendChild(r),o.appendChild(s),n.appendChild(o),document.createElement("button")),f=(h.classList.add("btn","p-0"),h.innerHTML='<i class="fas fa-edit"></i>',h.addEventListener("click",()=>{console.log("Editando empresa "+t);var e=function(t){const e=document.createElement("div"),a=(e.id="field_empresa_container",e.classList.add("form-group","p-3","bg-light","rounded"),document.createElement("input")),m=(a.type="text",a.placeholder="Pesquisar empresas...",a.classList.add("form-control","mb-3","shadow-sm"),e.appendChild(a),document.createElement("div")),n=(m.id="checkboxes_container",m.style.maxHeight="200px",m.style.overflowY="auto",e.appendChild(m),fetch("/api/empresas/").then(e=>e.json()).then(e=>{Array.isArray(e)?(e.slice(0,2).forEach(e=>{var a=document.createElement("div"),t=(a.classList.add("card","mb-3","border","shadow-sm","p-2","empresa-card"),document.createElement("div")),n=(t.classList.add("card-body","d-flex","align-items-center"),t.style.padding="3px",document.createElement("div")),o=(n.classList.add("empresa-avatar"),n.textContent=e.nome.split(" ").map(e=>e[0]).join("").substring(0,2).toUpperCase(),document.createElement("div")),r=(o.classList.add("ms-3","w-100"),document.createElement("div")),s=(r.classList.add("form-check"),document.createElement("input")),d=(s.type="checkbox",s.id="empresa_"+e.id,s.name="field_empresa",s.value=e.id,s.classList.add("form-check-input"),s.addEventListener("change",function(){this.checked&&m.querySelectorAll('input[type="checkbox"]').forEach(e=>{e!==this&&(e.checked=!1)});var e=C();console.log("Empresas selecionadas:",e)}),document.createElement("label")),l=(d.htmlFor="empresa_"+e.id,d.innerHTML=`<strong>${e.nome}</strong>`,d.classList.add("form-check-label"),document.createElement("hr")),i=(l.classList.add("my-2"),document.createElement("p")),c=(i.innerHTML="<strong>Razão Social:</strong> "+e.razao_social,i.classList.add("card-text","text-muted"),document.createElement("p")),p=(c.innerHTML="<strong>Regime Tributário:</strong> "+e.regime_tributario_nome,c.classList.add("card-text","text-muted"),document.createElement("p"));p.innerHTML="<strong>Cidade:</strong> "+e.cidade,p.classList.add("card-text","text-muted"),r.appendChild(s),r.appendChild(d),o.appendChild(r),o.appendChild(l),o.appendChild(i),o.appendChild(c),o.appendChild(p),t.appendChild(n),t.appendChild(o),a.appendChild(t),m.appendChild(a)}),a.addEventListener("input",function(){const t=a.value.toLowerCase();m.querySelectorAll(".card").forEach(e=>{var a=e.querySelector("label").textContent.toLowerCase();e.style.display=a.includes(t)?"":"none"})})):(console.error("Formato de dados inesperado:",e),H("danger","Erro ao buscar empresas: Formato de dados inesperado"))}).catch(e=>{console.error("Erro ao buscar empresas:",e),H("danger","Erro ao buscar empresas: "+e.message)}),document.createElement("div")),o=(n.classList.add("d-flex","justify-content-end","mt-3"),document.createElement("button"));return o.classList.add("btn-sequence-enter"),o.id="save-card-btn",o.innerHTML=`
            Salvar
            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-floppy" viewBox="0 0 16 16">
                <path d="M11 2H9v3h2z"/>
                <path d="M1.5 0h11.586a1.5 1.5 0 0 1 1.06.44l1.415 1.414A1.5 1.5 0 0 1 16 2.914V14.5a1.5 1.5 0 0 1-1.5 1.5h-13A1.5 1.5 0 0 1 0 14.5v-13A1.5 1.5 0 0 1 1.5 0M1 1.5v13a.5.5 0 0 0 .5.5H2v-4.5A1.5 1.5 0 0 1 3.5 9h9a1.5 1.5 0 0 1 1.5 1.5V15h.5a.5.5 0 0 0 .5-.5V2.914a.5.5 0 0 0-.146-.353l-1.415-1.415A.5.5 0 0 0 13.086 1H13v4.5A1.5 1.5 0 0 1 11.5 7h-7A1.5 1.5 0 0 1 3 5.5V1H1.5a.5.5 0 0 0-.5.5m3 4a.5.5 0 0 0 .5.5h7a.5.5 0 0 0 .5-.5V1H4zM3 15h10v-4.5a.5.5 0 0 0-.5-.5h-9a.5.5 0 0 0-.5.5z"/>
            </svg>
        `,o.addEventListener("click",function(){var e=C(),a=0<e.length?e[0].id:null;console.log("Empresas selecionadas para salvar:",e,"Field:",t),fetch(`/api/updatecardfieldvalue/${t.id}/`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":M("csrftoken")},body:JSON.stringify({value:a})}).then(e=>{if(e.ok)return e.json();throw new Error("Erro ao atualizar o valor do campo")}).then(e=>{location.reload()}).catch(e=>{console.error("Erro ao atualizar o valor do campo:",e)})}),n.appendChild(o),e.appendChild(n),e}(a);n.parentNode&&n.parentNode.insertBefore(e,n.nextSibling),n.remove()}),n.appendChild(h),`/api/empresas/${t}/get_by_id/`);return fetch(f).then(e=>{if(e.ok)return e.json();throw new Error("Network response was not ok")}).then(e=>{l.innerHTML=`<strong>${e.nome_fantasia}</strong>`,c.innerHTML="<strong>Razão Social:</strong> "+e.razao_social,m.innerHTML="<strong>CNPJ:</strong> "+e.cnpj_cpf_caepf,p.innerHTML="<strong>Regime Tributário:</strong> "+e.regime_tributario_nome,u.innerHTML="<strong>Cidade:</strong> "+e.cidade,r.textContent=e.nome_fantasia.split(" ").map(e=>e[0]).join("")}).catch(e=>console.error("Error:",e)),n}(e),e=w(e),r=$(),s=_(),d=(s.style.marginLeft="10px",k(o.querySelector("button"),e,r,s,o.querySelector("span")),L(r,e,o.querySelector("span"),o.querySelector("button"),s),q(s,e,r,o.querySelector("span"),o.querySelector("button")),document.createElement("div"));return d.classList.add("d-inline-flex","align-items-center","gap-2"),d.appendChild(r),d.appendChild(s),a.appendChild(t),a.appendChild(n),a.appendChild(o),a.appendChild(e),a.appendChild(d),a}function g(e){var a=document.createElement("div"),t=(a.classList.add("form-group"),x(e)),n=E(e),o=function(e){const s=document.createElement("div"),a=(s.classList.add("d-flex","flex-column","align-items-start"),document.createElement("span")),t=(a.classList.add("form-text","text-muted","mb-2"),a.style.fontSize="0.89rem",a.style.color="#18183a",a.style.fontWeight="bold",document.createElement("button"));t.classList.add("btn","p-0"),t.innerHTML='<i class="fas fa-plus"></i>',s.appendChild(a),e.value?(e.value.split(",").forEach(e=>{var a=document.createElement("div"),t=(a.classList.add("d-flex","align-items-center"),a.style.marginBottom="0.5rem",document.createElement("button")),n=(t.classList.add("btn-sequence-enter","me-2"),e.trim().split("/").pop().split("?")[0]);let o="",r="";switch(n.split(".").pop().toLowerCase()){case"zip":o="bi bi-file-earmark-zip",r="btn-warning";break;case"xls":case"xlsx":o="bi bi-file-earmark-spreadsheet",r="btn-success";break;case"txt":o="bi bi-file-earmark-text",r="btn-secondary";break;case"pdf":o="bi bi-file-earmark-pdf",r="btn-danger";break;case"png":case"jpg":o="bi bi-file-earmark-image",r="btn-primary";break;default:o="bi bi-file-earmark",r="btn-light"}t.classList.add(r),t.innerHTML=`
                    <a href="${e.trim()}" target="_blank" style="text-decoration: none; color: inherit;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="${o}" viewBox="0 0 16 16">
                            <path d="M14 4.5V14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h5.5L14 4.5zM10.5 3a.5.5 0 0 1 .5.5V4h2a.5.5 0 0 1 .5.5v9a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5v2.5a.5.5 0 0 0 .5.5z"/>
                        </svg>
                    </a>`;e=document.createElement("span");e.classList.add("ms-1"),e.textContent=n,a.appendChild(t),a.appendChild(e),s.appendChild(a)}),a.textContent=""):(a.textContent="Clique aqui para adicionar",console.log("Clique aqui para adicionar"));return s.appendChild(t),t.addEventListener("click",()=>{{var r=e;const s=document.createElement("input");s.type="file",s.multiple=!0,s.className="form-control",s.id="dynamicFileInput",document.body.appendChild(s),console.log("Criando input para receber anexos"),s.addEventListener("change",async()=>{var e=Array.from(s.files),a=e.map(e=>e.name).join(", ");async function t(a){let e=2<(t=window.location.hostname.split(".")).length?t[0]:"sequence";e.endsWith("/")||(e+="/"),console.log("Prefixo gerado:",e);var t="/upload_file_to_s3/"+e,n=new FormData;for(let e=0;e<a.length;e++)n.append("file",a[e]);try{var o,r=await fetch(t,{method:"POST",body:n});if(r.ok)return o=await r.json(),console.log("Upload bem-sucedido:",o),console.log("Salvo em prefixo:",e),o.urls;throw new Error("Erro ao fazer upload do arquivo")}catch(e){throw console.error("Erro:",e),e}}console.log("Arquivos selecionados: "+a);try{var n=await t(e),o=(console.log("URLs dos arquivos enviados:",n),n.join(", "));fetch(`/api/updatecardfieldvalue/${r.id}/`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":M("csrftoken")},body:JSON.stringify({value:o})}).then(e=>{if(e.ok)return e.json();throw new Error("Erro ao atualizar o valor do campo")}).then(e=>{console.log("Valor do campo atualizado com sucesso:",e),location.reload()}).catch(e=>{console.error("Erro ao atualizar o valor do campo:",e)})}catch(e){console.error("Erro ao enviar arquivos:",e)}}),s.click()}}),s}(e),e=w(e),r=$(),s=_(),d=(s.style.marginLeft="10px",k(o.querySelector("button"),e,r,s,o.querySelector("span")),L(r,e,o.querySelector("span"),o.querySelector("button"),s),q(s,e,r,o.querySelector("span"),o.querySelector("button")),document.createElement("div"));return d.classList.add("d-inline-flex","align-items-center","gap-2"),d.appendChild(r),d.appendChild(s),a.appendChild(t),a.appendChild(n),a.appendChild(o),a.appendChild(e),a.appendChild(d),a}function y(d,l){fetch(`/api/card/${d}/`).then(e=>{if(e.ok)return e.json();throw new Error("Erro na resposta da API: "+e.statusText)}).then(e=>{var a=e.field_values,t=a.filter(e=>"Formulário Inicial"===e.formulario_titulo),a=a.filter(e=>e.fase_nome_field===l&&"Formulário Inicial"!==e.formulario_titulo);t.sort((e,a)=>e.form_field-a.form_field),a.sort((e,a)=>e.form_field-a.form_field);const n=document.getElementById("formulario-inicial-card-"+d);if(n){n.innerHTML="";var o,r=t.find(e=>"empresa"===e.field_type),r=(r&&(r.value?(o=p(r),n.appendChild(o)):(o=b(r),n.appendChild(o))),t.find(e=>"attachment"===e.field_type)),r=(r&&(r.value?(o=g(r),n.appendChild(o)):(o=g(r),n.appendChild(o))),t.forEach(e=>{"empresa"!==e.field_type&&"attachment"!==e.field_type&&(e=b(e),n.appendChild(e))}),document.getElementById("spinner-formulario-inicial-"+d));r&&r.remove();const s=document.getElementById("formulario-fase-card-"+d);s?(s.innerHTML="",0===a.length?((o=document.createElement("span")).textContent=`A fase ${l} não possui nenhum campo.`,s.appendChild(o)):a.forEach(e=>{e=b(e);s.appendChild(e)}),(t=document.getElementById("spinner-formulario-fase-"+d))&&t.remove(),(r=document.getElementById("detalhes-adicionais-card-"+d))?(r.innerHTML="",o=function(e,a,t){var n=document.createElement("div"),o=(n.className="",n.style.overflowY="auto",n.style.maxHeight="100vh",document.createElement("h5"));o.className="text-muted",o.textContent="Detalhes Adicionais",n.appendChild(o),(o=document.createElement("h6")).className="text-muted",o.textContent="Alterações:",n.appendChild(o);(o=document.createElement("div")).className="accordion",o.id="accordionAlteracoes-"+e,n.appendChild(o);var r=document.createElement("div");r.className="accordion-item",o.appendChild(r);(o=document.createElement("h5")).className="accordion-header",o.id="headingAlteracoes-"+e,r.appendChild(o);var s=document.createElement("div");s.className="d-flex align-items-center",o.appendChild(s);(o=document.createElement("div")).className="p-2",s.appendChild(o);var d=document.createElement("i");d.className="fas fa-edit",o.appendChild(d),(o=document.createElement("button")).className="accordion-button collapsed",o.type="button",o.dataset.bsToggle="collapse",o.dataset.bsTarget="#collapseAlteracoes-"+e,o.ariaExpanded="false",o.ariaControls="collapseAlteracoes-"+e,o.textContent="Ver Alterações",s.appendChild(o),(d=document.createElement("div")).id="collapseAlteracoes-"+e,d.className="accordion-collapse collapse",d.ariaLabelledby="headingAlteracoes-"+e,d.dataset.bsParent="#accordionAlteracoes-"+e,r.appendChild(d),(s=document.createElement("div")).className="accordion-body",d.appendChild(s);const l=document.createElement("ul"),i=(l.className="list-group mb-3",s.appendChild(l),a&&a[e]?a[e].forEach(e=>{var a=document.createElement("li"),t=(a.className="list-group-item",l.appendChild(a),document.createElement("i")),t=(t.className="fas fa-history me-2",a.appendChild(t),document.createElement("small"));t.className="text-muted",t.textContent=e.atualizado_por+` alterou ${e.campo} de ${e.antigo_valor} para ${e.novo_valor} em: `+new Date(e.atualizado_em).toLocaleString("pt-BR"),a.appendChild(t)}):((o=document.createElement("span")).className="text-muted",o.textContent="Nenhuma alteração encontrada.",s.appendChild(o)),(r=document.createElement("h6")).className="text-muted",r.textContent="Movimentações:",n.appendChild(r),(d=document.createElement("div")).className="accordion",d.id="accordionMovimentacoes-"+e,n.appendChild(d),(a=document.createElement("div")).className="accordion-item",d.appendChild(a),(s=document.createElement("h5")).className="accordion-header",s.id="headingMovimentacoes-"+e,a.appendChild(s),(o=document.createElement("div")).className="d-flex align-items-center",s.appendChild(o),(r=document.createElement("div")).className="p-2",o.appendChild(r),(d=document.createElement("i")).className="fas fa-info-circle",r.appendChild(d),(s=document.createElement("button")).className="accordion-button collapsed",s.type="button",s.dataset.bsToggle="collapse",s.dataset.bsTarget="#collapseMovimentacoes-"+e,s.ariaExpanded="false",s.ariaControls="collapseMovimentacoes-"+e,s.textContent="Ver Movimentações",o.appendChild(s),(r=document.createElement("div")).id="collapseMovimentacoes-"+e,r.className="accordion-collapse collapse",r.ariaLabelledby="headingMovimentacoes-"+e,r.dataset.bsParent="#accordionMovimentacoes-"+e,a.appendChild(r),(d=document.createElement("div")).className="accordion-body",r.appendChild(d),document.createElement("ul"));return i.className="list-group mb-3",d.appendChild(i),t&&t[e]?t[e].forEach(e=>{var a=document.createElement("li"),t=(a.className="list-group-item",i.appendChild(a),document.createElement("i")),t=(t.className="fas fa-comment-dots me-2",a.appendChild(t),document.createElement("small"));t.className="text-muted",t.textContent=e.movido_por+` moveu de ${e.fase_origem} para ${e.fase_destino} em: `+new Date(e.data_movimento).toLocaleString("pt-BR"),a.appendChild(t)}):((o=document.createElement("span")).className="text-muted",o.textContent="Nenhuma movimentação encontrada.",d.appendChild(o)),n}(d,e.alteracoes,e.movimentacao),r.appendChild(o)):console.error("Contêiner de detalhes adicionais não encontrado para o card "+d)):console.error("Contêiner de formulário da fase não encontrado para o card "+d)}else console.error("Contêiner de formulário inicial não encontrado para o card "+d)}).catch(e=>{console.error(`Erro ao buscar campos do card ${d}:`,e)})}function b(e){var a,t=document.createElement("div"),n=(t.classList.add("form-group"),x(e)),o=E(e),r=(r=e,(d=document.createElement("div")).classList.add("d-flex","align-items-center"),(s=document.createElement("span")).classList.add("form-text","text-muted","me-2"),s.style.fontSize="0.89rem",s.style.color="#18183a",s.style.fontWeight="bold","due_date"===r.field_type&&r.value?(a=new Date(r.value).toLocaleString("pt-BR",{dateStyle:"short",timeStyle:"short"}),s.textContent=a):s.textContent=r.value||"Clique aqui para adicionar",(a=document.createElement("button")).classList.add("btn","p-0"),a.innerHTML='<i class="fas fa-edit"></i>',d.appendChild(s),d.appendChild(a),d),s=w(e),d=$(),e=_(),l=(e.style.marginLeft="10px",k(r.querySelector("button"),s,d,e,r.querySelector("span")),L(d,s,r.querySelector("span"),r.querySelector("button"),e),q(e,s,d,r.querySelector("span"),r.querySelector("button")),document.createElement("div"));return l.classList.add("d-inline-flex","align-items-center","gap-2"),l.appendChild(d),l.appendChild(e),t.appendChild(n),t.appendChild(o),t.appendChild(r),t.appendChild(s),t.appendChild(l),t}function x(e){var a=document.createElement("i");switch(e.field_type){case"short_text":a.className="fas fa-font";break;case"long_text":a.className="fas fa-align-left";break;case"number":a.className="fas fa-hashtag";break;case"select":a.className="fas fa-list";break;case"cnpj":case"cpf":a.className="fas fa-id-card";break;case"currency":a.className="fas fa-dollar-sign";break;case"attachment":a.className="fas fa-paperclip";break;case"assignee_select":a.className="fas fa-user";break;case"date":a.className="fas fa-calendar-alt";break;case"datetime":case"time":a.className="fas fa-clock";break;case"due_date":a.className="fas fa-calendar-check";break;case"label_select":a.className="fas fa-tags";break;case"phone":a.className="fas fa-phone";break;case"checklist_vertical":a.className="fas fa-tasks";break;case"statement":a.className="fas fa-file-alt";break;case"radio_horizontal":case"radio_vertical":a.className="fas fa-dot-circle";break;case"checkbox_horizontal":case"checkbox_vertical":a.className="fas fa-check-square";break;case"email":a.className="fas fa-envelope";break;case"url":a.className="fas fa-link";break;case"address":a.className="fas fa-map-marker-alt";break;case"empresa":a.className="fas fa-building";break;default:a.className=""}e=document.createElement("div");return e.classList.add("icon-box"),e.appendChild(a),e}function E(e){var a=document.createElement("label");return a.htmlFor="field_"+e.id,a.textContent=e.form_field_label,a.classList.add("form-label"),a}function C(){var e=document.querySelectorAll('input[name="field_empresa"]:checked');return Array.from(e).map(e=>{var a=e.closest(".card").querySelector("label").textContent.trim();return{id:e.value,nome:a}})}function w(e){let t;switch(e.field_type){case"short_text":(t=document.createElement("input")).type="text",t.placeholder="Digite aqui";break;case"long_text":(t=document.createElement("textarea")).placeholder="Digite aqui";break;case"email":(t=document.createElement("input")).type="email",t.placeholder="Digite aqui";break;case"cpf":(t=document.createElement("input")).type="text",t.pattern="\\d{3}\\.\\d{3}\\.\\d{3}-\\d{2}",t.placeholder="000.000.000-00",t.addEventListener("input",function(){let e=t.value.replace(/\D/g,"");e=(e=(e=(e=11<e.length?e.slice(0,11):e).replace(/(\d{3})(\d)/,"$1.$2")).replace(/(\d{3})(\d)/,"$1.$2")).replace(/(\d{3})(\d{1,2})$/,"$1-$2"),t.value=e});break;case"cnpj":(t=document.createElement("input")).type="text",t.pattern="\\d{2}\\.\\d{3}\\.\\d{3}/\\d{4}-\\d{2}",t.placeholder="00.000.000/0000-00",t.addEventListener("input",function(){let e=t.value.replace(/\D/g,"");e=(e=(e=(e=(e=14<e.length?e.slice(0,14):e).replace(/(\d{2})(\d)/,"$1.$2")).replace(/(\d{3})(\d)/,"$1.$2")).replace(/(\d{3})(\d)/,"$1/$2")).replace(/(\d{4})(\d{1,2})$/,"$1-$2"),t.value=e});break;case"currency":(t=document.createElement("input")).type="text",t.pattern="\\d+(\\.\\d{2})?",t.placeholder="0.00",t.addEventListener("input",function(){let e=t.value.replace(/\D/g,"");e=(e=((e=15<e.length?e.slice(0,15):e)/100).toFixed(2).replace(".",",")).replace(/\B(?=(\d{3})+(?!\d))/g,"."),t.value="R$ "+e});break;case"phone":(t=document.createElement("input")).type="tel",t.pattern="\\(\\d{2}\\) \\d{4,5}-\\d{4}",t.placeholder="(00) 00000-0000",t.addEventListener("input",function(){let e=t.value.replace(/\D/g,"");e=(e=(e=11<e.length?e.slice(0,11):e).replace(/(\d{2})(\d)/,"($1) $2")).replace(/(\d{4,5})(\d{4})$/,"$1-$2"),t.value=e});break;case"number":(t=document.createElement("input")).type="number",t.placeholder="Digite o número";break;case"date":case"due_date":(t=document.createElement("input")).type="datetime-local",e.value&&(a=new Date(e.value).toISOString().slice(0,16),t.value=a);break;case"datetime":(t=document.createElement("input")).type="datetime-local";break;case"time":(t=document.createElement("input")).type="time";break;case"select":case"assignee_select":case"label_select":t=document.createElement("select");var a=document.createElement("option");a.textContent="Selecione uma opção",a.value="",a.disabled=!0,a.selected=!0,t.appendChild(a),e.options&&Array.isArray(e.options)&&e.options.forEach(e=>{var a=document.createElement("option");a.textContent=e.label,a.value=e.value,t.appendChild(a)});break;case"attachment":(t=document.createElement("input")).type="text";break;case"checklist_vertical":case"radio_horizontal":t=document.createElement("div");break;case"statement":t=document.createElement("textarea");break;default:(t=document.createElement("input")).type="text"}return t.id="field_"+e.id,t.name="field_"+e.id,t.value=e.value||"",t.classList.add("form-control","mt-2"),t.style.display="none",e.required&&t.setAttribute("required","required"),t}function $(){var e=document.createElement("button");return e.type="submit",e.classList.add("btn-sequence-enter"),e.id="save-card-btn",e.innerHTML=`
            Salvar
            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-floppy" viewBox="0 0 16 16">
                <path d="M11 2H9v3h2z"/>
                <path d="M1.5 0h11.586a1.5 1.5 0 0 1 1.06.44l1.415 1.414A1.5 1.5 0 0 1 16 2.914V14.5a1.5 1.5 0 0 1-1.5 1.5h-13A1.5 1.5 0 0 1 0 14.5v-13A1.5 1.5 0 0 1 1.5 0M1 1.5v13a.5.5 0 0 0 .5.5H2v-4.5A1.5 1.5 0 0 1 3.5 9h9a1.5 1.5 0 0 1 1.5 1.5V15h.5a.5.5 0 0 0 .5-.5V2.914a.5.5 0 0 0-.146-.353l-1.415-1.415A.5.5 0 0 0 13.086 1H13v4.5A1.5 1.5 0 0 1 11.5 7h-7A1.5 1.5 0 0 1 3 5.5V1H1.5a.5.5 0 0 0-.5.5m3 4a.5.5 0 0 0 .5.5h7a.5.5 0 0 0 .5-.5V1H4zM3 15h10v-4.5a.5.5 0 0 0-.5-.5h-9a.5.5 0 0 0-.5.5z"/>
            </svg>
        `,e.style.display="none",e}function _(){var e=document.createElement("button");return e.type="button",e.classList.add("btn","btn-secondary","mt-2"),e.id="cancel-card-btn",e.innerHTML=`
            Cancelar
            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-x-circle" viewBox="0 0 16 16">
                <path d="M8 1a7 7 0 1 0 0 14A7 7 0 0 0 8 1zM4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
            </svg>
        `,e.style.display="none",e}function k(e,a,t,n,o){e.addEventListener("click",()=>{"Clique aqui para adicionar"===o.textContent&&(o.textContent=""),a.style.display="block",t.style.display="inline-block",n.style.display="inline-block",o.style.display="none",e.style.display="none",a.dataset.oldValue=a.value})}function L(a,t,n,o,r){a.addEventListener("click",()=>{t.dataset.oldValue;var e=t.value;n.textContent=e,t.style.display="none",a.style.display="none",r.style.display="none",n.style.display="inline",o.style.display="inline-block",fetch(`/api/updatecardfieldvalue/${t.id.split("_")[1]}/`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":M("csrftoken")},body:JSON.stringify({value:e})}).then(e=>{if(e.ok)return e.json();throw new Error("Erro ao atualizar o valor do campo")}).then(e=>{location.reload()}).catch(e=>{console.error("Erro ao atualizar o valor do campo:",e)})})}function q(e,a,t,n,o){e.addEventListener("click",()=>{a.style.display="none",t.style.display="none",e.style.display="none",n.style.display="inline",o.style.display="inline-block",a.value=n.textContent})}function S(s){var e="customModal-"+s.id,a=document.getElementById(e);a&&a.classList.contains("show")?console.log(`Modal para o card ${s.id} já está visível.`):(a&&(a.remove(),console.log(`Modal existente para o card ${s.id} removido.`)),async function(i,c){const p=await async function(t){console.log("Card: para consulta de responsavel",t.id);try{var e=await fetch(`/api/cardresponsavel/${t.id}/`);if(!e.ok)throw new Error("Network response was not ok");const n=await e.json();return console.log("Responsáveis do card:",n),console.log("Nome:",n.responsavel_nome),console.log("Foto:",n.responsavel_foto_perfil),n.responsavel_nome&&0<n.responsavel_nome.length?n.responsavel_nome.map((e,a)=>{a=n.responsavel_foto_perfil[a];return a?`<img id="responsavel-${t.id}" src="${a}" alt="${e}" title="${e}" style="width: 24px; height: 24px; border-radius: 50%; margin-right: 1px;">`:e}).join(" "):'<i class="mdi mdi-account-outline" style="color: red;"></i> N/R'}catch(e){return console.error("Erro ao buscar os responsáveis:",e),'<i class="mdi mdi-account-outline" style="color: red;"></i> N/R'}}(c),m=function(e){return e.vencimento?e.tempo_para_vencimento.includes("Vencido")?`<span class="badge bg-danger text-white">${e.tempo_para_vencimento}</span>`:e.tempo_para_vencimento.includes("minutos")||e.tempo_para_vencimento.includes("horas")?`<span class="badge bg-warning text-dark">${e.tempo_para_vencimento}</span>`:`<span class="badge bg-dark text-white">${e.tempo_para_vencimento}</span>`:""}(c);return fetch("/api/colaboradores/").then(e=>{if(e.ok)return e.json();throw new Error("Network response was not ok "+e.statusText)}).then(e=>e.map(e=>`
                    <li class="dropdown-item" id="dropdown-item-${e.id}">
                        <input type="checkbox" name="colaboradores" value="${e.id}" style="margin-right: 10px;">
                        <img src="${e.foto_perfil}" alt="${e.nome}" title="${e.nome}" style="width: 24px; height: 24px; border-radius: 50%; margin-right: 1px;">
                        <label for="colaboradores">${e.nome}</label>
                    </li>
                `).join("")).catch(e=>(console.error("There has been a problem with your fetch operation:",e),"")).then(e=>{var a,t,n,o=document.createElement("div");o.className="modal fade",o.id=i,o.tabIndex=-1,o.setAttribute("aria-hidden","true"),o.innerHTML=(a=c,t=p,n=m,e=e,`
            <div class="modal-dialog modal-fullscreen">
                <div class="modal-content">
                    <div class="modal-header-sequence" style="border-top: 4px solid ${f}; border-radius: 10px; background: #fff;">
                        <h4 class="modal_card_title me-2" id="addNewcardModalLabel" style="display: flex; align-items: center;">
                            <span style="
                                display: inline-flex;
                                align-items: center;
                                justify-content: center;
                                width: 32px;
                                height: 32px;
                                border-radius: 50%;
                                background-color: ${f};
                                color: #F7F7F7;
                                margin-right: 10px;
                                font-size: 14px;
                                padding: 0;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-plus" viewBox="0 0 16 16">
                                    <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4"/>
                                </svg>                    
                            </span>
                            <span class="card-title-text" data-card-id="${a.id}">${a.titulo}</span>
                            <input type="text" class="card-title-input" style="display: none;" value="${a.titulo}">
                        </h4>
                        <div class="d-flex justify-content-center align-items-center w-100">
                            <div class="btn-group me-2">
                                <button type="button" class="btn btn-outline-danger delete-card" data-card-id="${a.id}">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
                                        <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/>
                                        <path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/>
                                    </svg>
                                </button>
                            </div>
                            <div class="btn-group me-2" id="dropdown-fases">
                                <button type="button" class="btn-sequence-create dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                    Fase
                                </button>
                                <ul class="dropdown-menu" id="fase-dropdown-menu">
                                    ${a.fases_sequencia.sort((e,a)=>e.index-a.index).map(e=>`<li><a class="dropdown-item" data-fase="${e.id}" data-card-id="${a.id}" data-fase-nome="${e.nome}">${e.nome}</a></li>`).join("")}
                                </ul>
                            </div>    
                            <div>
                                <span class="tag" style="background-color: ${f}">${a.fase_nome}</span>
                            </div>
                        </div>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body" style="max-height: 70vh; overflow-y: overlay; scrollbar-width: thin; scrollbar-color: #E5E5E5 #F7F7F7; padding: 16px 32px 0px;">
                        <div class="row">
                            <div class="col-md-4 bg-light p-3" style="max-height: 70vh; overflow-y: overlay; scrollbar-width: thin; scrollbar-color: #E5E5E5 #F7F7F7; padding: 16px 32px 0px;">
                                <span class="text-muted d-flex align-items-center mt-1" style="font-size: 14px; gap: 8px;"> 
                                    <span id="responsavel-container-modal${a.id}">
                                        ${t}
                                    </span>
                                    <button id="dropdownColaboradoresBtn" style="width: 24px; height: 24px; border-radius: 50%; margin-right: 1px;">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                    <div class="dropdown">
                                        <ul class="dropdown-menu" id="dropdownColaboradores" style="
                                            max-height: 432px; 
                                            position: relative; 
                                            background: var(--light-base); 
                                            border: 1px solid var(--gray-600); 
                                            border-radius: var(--radius-default); 
                                            display: flex; 
                                            flex-direction: column; 
                                            box-shadow: rgba(102, 102, 102, 0.05) 0px 3px 17px, 
                                                        rgba(102, 102, 102, 0.06) 0px 9px 14px, 
                                                        rgba(102, 102, 102, 0.09) 0px 4px 6px; 
                                            overflow: auto; 
                                            width: 100%; 
                                            --dropdown-item-spacing-left: 20px; 
                                            --dropdown-item-spacing-right: 20px; 
                                            --dropdown-item-spacing-y: 11px;">
                                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 1px;">
                                                <span class="dropdown-item-text" style="font-weight: bold; font-size: 16px;">Adicionar Responsáveis</span>
                                            </div>
                                            <hr>
                                            ${e}
                                        </ul>
                                    </div>
                                    ${n}
                                </span>
                                <hr>
                                <h5 class="text-muted">Formulário Inicial</h5>
                                <div id="spinner-formulario-inicial-${a.id}" class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Carregando...</span>
                                </div>
                                <div id="formulario-inicial-card-${a.id}"></div>
                            </div>
                            <div class="col-md-4 p-3" style="max-height: 70vh; overflow-y: overlay; scrollbar-width: thin; scrollbar-color: #E5E5E5 #F7F7F7; padding: 16px 32px 0px;">
                                <div id="detalhes-adicionais-card-${a.id}"></div>
                            </div>
                            <div class="col-md-4 bg-light p-3">
                                <h5 class="text-muted">Formulário da fase <span class="badge bg-secondary"></span></h5>
                                <div id="spinner-formulario-fase-${a.id}" class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Carregando...</span>
                                </div>
                                <div id="formulario-fase-card-${a.id}"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>`);{var r=o,s=c;const d=r.querySelector(".card-title-text"),l=r.querySelector(".card-title-input");d.addEventListener("dblclick",()=>{d.style.display="none",l.style.display="inline",l.focus()}),l.addEventListener("blur",()=>{var t,n;d.textContent=l.value,d.style.display="inline",l.style.display="none",t=s.id,n=l.value,fetch(`/api/cards/${t}/update-title/`,{method:"PATCH",headers:{"Content-Type":"application/json","X-CSRFToken":M("csrftoken")},body:JSON.stringify({titulo:n})}).then(e=>{if(e.ok)return e.json();throw new Error("Erro ao atualizar o título do card")}).then(e=>{var a=document.querySelector("#card-title-"+t);a?(a.textContent=e.titulo,h.send(JSON.stringify({event:"update_card_title",card_id:t,new_title:n}))):console.warn(`⚠️ Elemento do título do card ${t} não encontrado.`)}).catch(e=>{console.error("Erro ao atualizar o título do card:",e)})}),r.querySelector("#dropdownColaboradoresBtn").addEventListener("click",()=>{var e=r.querySelector("#dropdownColaboradores");e.style.display="none"===e.style.display?"block":"none"})}return o})}(e,s).then(e=>{var a,t,n,r;document.body.appendChild(e),new bootstrap.Modal(e).show();const o=e.querySelector("#dropdownColaboradores");o&&(o.style.display="none"),a=s.id,(t=document.getElementById("formulario-inicial-card-"+a))?t.innerHTML="":console.error("Contêiner de formulário não encontrado para o card "+a),y(s.id,s.fase_nome),n=s.id,e.querySelector(".delete-card").addEventListener("click",function(){var a,e;a=n,e=M("csrftoken"),fetch(`/card/${a}/delete/`,{method:"DELETE",headers:{"Content-Type":"application/json","X-CSRFToken":e}}).then(a=>a.ok?a.json():a.text().then(e=>{throw new Error(e||"Erro na requisição. Status: "+a.status)})).then(e=>{e.success?(h.send(JSON.stringify({event:"delete_card",card_id:a})),N("success","Card deletado com sucesso!"),i(a),location.reload()):N("danger",e.error||"Erro desconhecido ao deletar o card.")}).catch(e=>{console.error("Erro:",e.message),N("danger","Erro deletar card: "+e.message)})}),(r=e).querySelectorAll("#dropdown-fases .dropdown-item").forEach(e=>{e.addEventListener("click",async function(e){var a=this.getAttribute("data-fase"),t=this.getAttribute("data-card-id"),n=this.getAttribute("data-fase-nome");if(t)try{var o=await(await fetch("/update_card_phase/",{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":getCSRFToken()},body:JSON.stringify({card_id:t,new_phase_id:a})})).json();o.success?(H("success",n+" com sucesso!"),setTimeout(()=>{bootstrap.Modal.getInstance(r).hide()},3e3)):H("Erro ao atualizar o card: "+o.errors)}catch(e){console.error("Erro na requisição:",e),H("danger",e.message||"Erro desconhecido ao atualizar o card.")}else alert("Erro: ID do card não encontrado.")})}),o.addEventListener("change",e=>{if("colaboradores"===e.target.name){e=document.getElementById("dropdownColaboradores");const a=Array.from(e.querySelectorAll('input[name="colaboradores"]:checked')).map(e=>e.value);o.style.display="none",setTimeout(()=>{!async function(a,e){if(e&&0!==e.length){var t=`/api/update_responsaveis_card/${a}/`,e={responsavel_ids:e};try{var n,o,r=await fetch(t,{method:"PATCH",headers:{"Content-Type":"application/json","X-CSRFToken":M("csrftoken")},body:JSON.stringify(e)});r.ok?(o=await r.json(),console.log("Responsável atualizado:",o),function(a,e){try{console.log("Atualizando responsável no DOM:",a,e);const o=document.getElementById("responsavel-container-modal"+a),r=document.getElementById("responsavel-container-card"+a);o?r?(o.innerHTML="",r.innerHTML="",fetch(`/api/cardresponsavel/${a}/`).then(e=>e.json()).then(e=>{console.log("Card atualizado:",e);var a=document.createElement("span"),t=e.responsavel_nome||"Desconhecido",n=e.responsavel_foto_perfil||"none",a=(console.log("nome:",t),console.log("foto:",n),console.log("card id:",e.id),a.id="responsavel-container-modal"+e.id,a.innerHTML=`<img id="responsavel-${e.id}" src="${n}" alt="${t}" title="${t}" style="width: 24px; height: 24px; border-radius: 50%; margin-right: 1px;">`,o.appendChild(a),document.createElement("span"));a.id="responsavel-container-card"+e.id,a.innerHTML=`<img id="responsavel-${e.id}" src="${n}" alt="${t}" title="${t}" style="width: 24px; height: 24px; border-radius: 50%; margin-right: 1px;">`,r.appendChild(a)}).catch(e=>{console.error(`Erro ao buscar os dados do card ${a}:`,e)})):console.warn(`Não foi possível encontrar o contêiner do card para o card ${a}.`):console.warn(`Não foi possível encontrar o contêiner modal para o card ${a}.`)}catch(e){console.error(`Erro ao atualizar o responsável no DOM para o card ${a}:`,e)}}(a,o)):(n=await r.json(),console.error(`Erro ao atualizar responsáveis para o card ${a}:`,n))}catch(e){console.error(`Erro ao atualizar responsáveis do card ${a}:`,e)}}else console.warn(`Nenhum responsável selecionado para o card ${a}.`)}(s.id,a),console.log("Responsáveis selecionados:",a)},1e3)}})}).catch(e=>{console.error(`Erro ao criar o modal para o card ${s.id}:`,e)}))}function N(e,a){const t=document.getElementById("alert-container");e="success"===e;t.innerHTML=`
            <div class="alert-dark ${e?"alert-success":"alert-danger"}" role="alert">
                <strong>${e?"Success":"Error"} - </strong> 
                ${e?"Sucesso":a}
            </div>`,setTimeout(()=>{t.innerHTML=""},2e3)}function M(a){let t=null;return document.cookie&&""!==document.cookie&&document.cookie.split(";").forEach(e=>{(e=e.trim()).startsWith(a+"=")&&(t=decodeURIComponent(e.substring(a.length+1)))}),t}function T(){document.querySelectorAll(".sortable-cards").forEach(e=>{new Sortable(e,{group:"shared",animation:150,ghostClass:"sortable-ghost",onEnd:o})})}function o(e){var a,t=e.item.getAttribute("data-card-id"),n=e.from.closest(".phase-card-col"),o=e.to.closest(".phase-card-col"),r=n.getAttribute("data-fase-id"),s=o.getAttribute("data-fase-id"),o=(n.getAttribute("data-nome"),o.getAttribute("data-nome")),n=n.querySelector(`[data-card-id="${t}"]`);n&&n.remove(),A(e.from),A(e.to),n=t,e=s,a=o,fetch("/update_card_phase/",{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":M("csrftoken")},body:JSON.stringify({card_id:n,new_phase_id:e})}).then(e=>e.json()).then(e=>H(e.success,a,e.errors)).catch(e=>H(!1,"",e)),d[r]=Math.max((d[r]||0)-1,0),d[s]=(d[s]||0)+1,l(r),l(s),c(r,1,5)}function A(e){var a=e.querySelector(".ghost-card"),e=0<e.querySelectorAll(".card").length;a&&(a.style.display=e?"none":"block")}function M(a){let t=null;return document.cookie&&""!==document.cookie&&document.cookie.split(";").forEach(e=>{(e=e.trim()).startsWith(a+"=")&&(t=decodeURIComponent(e.substring(a.length+1)))}),t}function H(e,a,t){const n=document.getElementById("alert-container");n.innerHTML=`
            <div class="alert ${e?"alert-success":"alert-danger"}" role="alert">
                <strong>${e?"Success":"Error"} - </strong> 
                ${e?"Card Movido para a fase "+a:t}
            </div>`,setTimeout(()=>{n.innerHTML=""},2e3)}h.onmessage=function(e){var a,t,n,o,e=JSON.parse(e.data);"card_updated"===e.event?(a=e.card_id,t=e.new_phase_id,n=document.querySelector(`[data-card-id="${a}"]`),o=document.querySelector(`.phase-cards[data-fase-id="${t}"]`),n?o?o.appendChild(n):console.warn(`⚠️ Nova fase ${t} não encontrada no DOM.`):console.warn(`⚠️ Card ${a} não encontrado no DOM.`),l(e.old_phase_id),l(e.new_phase_id)):"card_deleted"===e.event?(i(e.card_id),l(e.phase_id)):"card_title_updated"===e.event?(o=document.querySelector(`.card-title-text[data-card-id="${e.card_id}"]`),n=document.querySelector(`.card-title-modal-text[data-card-id="${e.card_id}"]`),o?o.textContent=e.new_title:console.warn(`⚠️ Elemento do título do card ${e.card_id} não encontrado no DOM.`),n?n.textContent=e.new_title:console.warn(`⚠️ Elemento do título do card modal ${e.card_id} não encontrado no DOM.`)):"card_responsavel_updated"===e.event&&((t=document.querySelector(`[data-card-id="${e.card_id}"]`))?t.querySelector("#card-responsavel").innerHTML=e.responsaveis_html:console.warn(`⚠️ Elemento do card ${e.card_id} não encontrado no DOM.`))},new bootstrap.Modal(document.getElementById("spinnerModal")).show(),fetch(`/api/sequencia/${m}/fases/`).then(e=>e.json()).then(e=>{n(),e.length&&(e.forEach(e=>{{var t=e;(e=document.createElement("div")).className="phase-card-col",e.id="fase"+t.id,e.setAttribute("data-fase-id",t.id),e.setAttribute("data-nome",t.nome),e.innerHTML=`
            <div class="phase-header" style="
                position: sticky; 
                top: 0; 
                background: #fff; 
                z-index: 999; 
                margin: 10px auto; 
                padding: 10px;
                border-radius: 10px;
                position: relative;
                isolation: isolate;">

                <!-- Pseudo-elemento para a borda gradiente -->
                <div style="
                    position: absolute;
                    top: 0; left: 0; right: 0; bottom: 0;
                    border-radius: 10px;
                    padding: 1px; /* Espessura da borda */
                    background: linear-gradient(170deg,  ${f}, #FFFFFF);
                    -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
                    -webkit-mask-composite: destination-out;
                    mask-composite: exclude;
                    z-index: -1;">
                </div>

            <h5 class="task-header text-uppercase d-flex justify-content-between align-items-center">
                <!-- Indicador de cor da fase -->
                <span style="width: 12px; height: 12px; background:  ${f}; border-radius: 50%; margin-right: 8px; flex-shrink: 0;"></span>
                
                <!-- Nome da fase -->
                <span style="color: #18183A; font-weight: 500; font-size: 14px; flex-grow: 1;">
                    ${t.nome}
                </span>
                
                <!-- Quantidade de cards -->
                <span style="border-radius: 8px; background: #F8F8F8; padding: 6px 12px; color: #6C75A2; font-weight: 400; border: 1px solid #6C75A2; font-size: 12px; flex-shrink: 0;">
                    ${t.quantidade_cards} Cards
                </span>
            </h5>
            
            </div>
            <div class="tasks" id="tasks${t.id}" style="overflow-y: auto; max-height: auto;">
                <div class="spinner-container" id="spinner-container-${t.id}">
                    <div class="spinner-border" role="status" style="color: #007bff;">
                        <span class="sr-only"></span>
                    </div>
                </div>
                <div class="phase-cards sortable-cards" data-fase-id="${t.id}">
                    <div class="ghost-card text-center border rounded p-3" style="display: none;">Arraste um card aqui</div>
                </div>
            </div>`,a.appendChild(e),c(t.id,0),d[t.id]=t.quantidade_cards;const n={[t.id]:2},o={[t.id]:!0},r={[t.id]:!1},s=e.querySelector("#tasks"+t.id);s.addEventListener("scroll",function(){if(s.scrollTop+s.clientHeight>=s.scrollHeight-5&&o[t.id]&&!r[t.id]){let a=document.getElementById("spinner-load-more-"+t.id);a||((a=document.createElement("div")).id="spinner-load-more-"+t.id,a.className="spinner-container d-flex justify-content-center",a.innerHTML=`
                        <div class="sequence-card-body d-flex justify-content-center">
                            <button class="btn btn-primary" type="button" disabled>
                                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                Carregando cards...
                            </button>
                        </div>`,s.appendChild(a)),a.style.display="flex",r[t.id]=!0,setTimeout(()=>{c(t.id,n[t.id],10).then(e=>{0===e.length?o[t.id]=!1:n[t.id]++}).catch(e=>{console.error(`Erro ao carregar mais cards na fase ${t.id}:`,e),o[t.id]=!1,a.remove();e=document.createElement("span");e.className="text-danger",e.textContent="Todos os cards foram carregados.",s.appendChild(e)}).finally(()=>{a.style.display="none",setTimeout(()=>{r[t.id]=!1},1e3)})},500)}})}}),T())}).catch(e=>{var a;console.error("Erro ao buscar fases:",e),n(),e="Erro ao buscar fases.",a=new bootstrap.Modal(document.getElementById("errorModal")),document.getElementById("errorModalMessage").textContent=e,a.show()}),document.querySelectorAll(".tasks").forEach(e=>{e.addEventListener("scroll",function(){e.scrollTop+e.clientHeight>=e.scrollHeight-10&&c(e.id.replace("tasks",""),e.querySelectorAll(".card").length)})})});